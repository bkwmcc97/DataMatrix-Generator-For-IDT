<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>DataMatrix Generator For IDT</title>
<style>
  :root{
    --bg:#707070; --card:#66686c; --accent:#51ba5b; --muted:#9ca3af;
  }
  body{
    font-family: Inter, Roboto, system-ui;
    background:#5f5f5f; color:#e6eef6; margin:0; padding:32px;
    display:flex; justify-content:center;
  }
  .container{
    width:100%; max-width:920px; background:#2c2d30; border-radius:12px;
    padding:22px; box-shadow:0 8px 30px rgba(0,0,0,0.4);
  }
  input,textarea{
    width:100%; padding:10px; border-radius:8px; border:1px solid rgba(255,255,255,0.1);
    background:rgba(255,255,255,0.05); color:#fff; font-size:14px;
  }
  .grid{display:grid; grid-template-columns:1fr 1fr; gap:12px}
  .full{grid-column:1/-1}
  .btn{
    padding:10px 12px; background:var(--accent); border:none;
    border-radius:8px; color:#232323; font-weight:700; cursor:pointer;
  }
  .secondary{
    padding:10px 12px; background:transparent; border:1px solid rgba(255,255,255,0.2);
    border-radius:8px; color:var(--muted); cursor:pointer;
  }
  .output{
    background:#161616; border:1px dashed rgba(255, 255, 255, 0);
    padding:10px; border-radius:8px; font-family:monospace;
  }
  #barcodeWrap{margin-top:20px; text-align:center}
  canvas{background:#fff; padding:10px; border-radius:8px}
  @media(max-width:720px){ .grid{grid-template-columns:1fr;} }
</style>
</head>
<body>
  <main class="container">
    <h1>DataMatrix Generator For IDT</h1>

    <!-- INPUTS -->
    <div class="push-down">
      <div>
        <label>Lot type (AI 240)</label>
        <input id="lotType" type="text">
      </div>

      <div>
        <label>Expiry date (AI 17)</label>
        <input id="expiryManual" type="text" placeholder="Optional YYMMDD" maxlength="6" style="margin-top:6px">
      </div>

      <div>
        <label>Lot number (AI 10)</label>
        <input id="lotNumber" type="text">
      </div>

      <div>
        <label>Variable data (AI 21)</label>
        <input id="variableData" type="text" placeholder="No need to add here">
      </div>

      <div class="full">
        <label>Output mode</label><br>
        <label><input type="radio" name="mode" value="human" checked> Human-readable ([F1])</label>
        <label style="margin-left:20px"><input type="radio" name="mode" value="machine"> Machine-ready (FNC1 byte)</label>
      </div>

      <div class="full" style="margin-top:10px">
        <button id="generateBtn" class="btn">Generate Payload</button>
        <button id="copyBtn" class="secondary">Copy</button>
        <button id="downloadBtn" class="secondary">Download</button>
        <button id="resetBtn" class="secondary">Reset</button>
      </div>

      <div class="full">
    
        <div id="output" class="output">(generated datamatrix code will appear here)</div>
        <div style="margin-top:20px"></div>
      </div>
    </div>

    <!-- DATAMATRIX PREVIEW -->
    <div id="barcodeWrap">
      <h3>DataMatrix Preview - Please Scan for Correct Details</h3>
      <canvas id="barcode"></canvas>
    </div>

  </main>

<!-- BARCODE LIBRARY -->
<script src="https://unpkg.com/bwip-js/dist/bwip-js-min.js"></script>

<script>
(function(){
  const $ = sel => document.querySelector(sel);
  const lotType = $('#lotType');
  const expiryDate = $('#expiryDate');
  const expiryManual = $('#expiryManual');
  const lotNumber = $('#lotNumber');
  const variableData = $('#variableData');
  const output = $('#output');
  const barcodeCanvas = $('#barcode');

  const FNC1 = String.fromCharCode(29);

  function formatExpiry(dateStr){
    if(!dateStr) return null;
    const [Y,M,D] = dateStr.split("-");
    if(!Y) return null;
    return String(Y%100).padStart(2,"0") + M + D;
  }

  function buildPayload(lot, exp, lotNo, varData, mode){
    const sep = mode === "machine" ? FNC1 : "[F1]";
    return "240" + lot + sep +
           "17" + exp +
           "10" + lotNo + sep +
           "21" + (varData || "");
  }

  function renderBarcode(data){
    try{
      bwipjs.toCanvas(barcodeCanvas, {
        bcid: "datamatrix",
        text: data,
        scale: 4,
        includetext: false,
        parsefnc: true     // required so FNC1 (ASCII 29) is understood
      });
    }catch(e){
      console.error(e);
    }
  }

  $('#generateBtn').onclick = function(){
    const mode = document.querySelector("input[name='mode']:checked").value;

    const exp = expiryManual.value.trim() || formatExpiry(expiryDate.value);
    if(!exp || exp.length !== 6) {
      output.textContent = "Error: Expiry must be YYMMDD.";
      return;
    }

    const payload = buildPayload(
      lotType.value.trim(),
      exp,
      lotNumber.value.trim(),
      variableData.value.trim(),
      mode
    );

    output.textContent = payload;

    // For barcode, always use true GS1 FNC1 bytes
    const barcodeData = buildPayload(
      lotType.value.trim(),
      exp,
      lotNumber.value.trim(),
      variableData.value.trim(),
      "machine"
    );

    renderBarcode(barcodeData);
  }

  $('#copyBtn').onclick = function(){
    navigator.clipboard.writeText(output.textContent);
  }

  $('#downloadBtn').onclick = function(){
    const blob = new Blob([output.textContent], {type:"text/plain"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "datamatrix_payload.txt";
    a.click();
    URL.revokeObjectURL(url);
  }

  $('#resetBtn').onclick = function(){
    lotType.value = "";
    expiryDate.value = "";
    expiryManual.value = "";
    lotNumber.value = "";
    variableData.value = "";
    output.textContent = "(generated payload will appear here)";
    const ctx = barcodeCanvas.getContext("2d");
    ctx.clearRect(0,0,barcodeCanvas.width,barcodeCanvas.height);
  }
})();
</script>
</body>
</html>
